name: Build and Deploy Frontend

run-name: ${{ github.repository }} is building and deploying

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

env:
  IMAGE_NAME: ${{ secrets.ALIYUN_ACR_REGISTRY }}/taklip-container/yoda-web
  IMAGE_TAG_LATEST: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - run: echo "๐ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "๐ง This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "๐ The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      
      # - name: Install dependencies
      #   run: npm ci
      
      # - name: Run linting
      #   run: npm run lint
      
      # - name: Build application
      #   run: npm run build
      #   env:
      #     NEXT_PUBLIC_API_URL: http://www.taklip.com/api/v1
      #     NEXT_PUBLIC_APP_URL: http://www.taklip.com

      # - name: Set up QEMU (for multi-platform builds)
      #   uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      # - name: Build and push multi-platform Docker image to ACR
      - name: Build and push Docker image to ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          # platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG_LATEST }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Deploy to AliCloud ECS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USER }}
          key: ${{ secrets.ALIYUN_ECS_SSH_KEY }}
          # timeout: 30m
          # command_timeout: 30m
          # script_stop: true
          script: |
            echo ""
            echo "๐ Step 1: Logging into ACR..."
            echo "${{ secrets.ALIYUN_ACR_PASSWORD }}" | docker login ${{ secrets.ALIYUN_ACR_REGISTRY }} -u ${{ secrets.ALIYUN_ACR_USERNAME }} --password-stdin

            echo ""
            echo "๐ฅ Step 2: Pulling latest image..."
            docker pull ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG_LATEST }}

            echo ""
            echo "๐ท๏ธ Step 3: Tagging image for compose..."
            docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG_LATEST }} yoda-web:latest
            if docker images | grep yoda-web; then
              echo "โ Image tagged as yoda-web:latest"
              docker images | grep yoda-web
            else
              echo "โ Failed to tag image"
              docker images | grep yoda-web
              exit 1
            fi

            echo ""
            echo "๐ Step 4: Navigating to deployment directory..."
            cd /opt/project-yoda/yoda-web
            if [ -d "yoda-web" ]; then
              echo "โ Current directory: $(pwd)"
              echo "๐ Files in directory:"
              ls -la | head -20
              echo "๐ Files in directory:"
              ls -la | head -20
            else
              echo "โ Directory /opt/project-yoda/yoda-web does not exist!"
              echo "Available directories:"
              ls -la /opt/project-yoda/ || echo "/opt/project-yoda does not exist"
              exit 1
            fi

            echo ""
            echo "๐ Step 5: Stopping existing containers..."
            docker compose down yoda-web --remove-orphans || true
            echo "๐ Checking for remaining yoda-web containers:"
            docker ps -a | grep yoda-web || echo "โ No yoda-web containers found"

            echo ""
            echo "๐งน Step 6: Cleaning up..."
            docker container prune -f || true
            docker rm -f yoda-web 2>/dev/null || echo "No yoda-web container to remove"

            echo ""
            echo "๐ Step 7: Verifying docker-compose.yml..."
            if [ -f docker-compose.yml ]; then
              echo "โ docker-compose.yml exists"
              echo "File size: $(ls -lh docker-compose.yml | awk '{print $5}')"
              echo ""
              echo "๐ Checking yoda-web service configuration:"
              if docker compose config 2>&1 | grep -A 15 yoda-web; then
                echo "โ yoda-web service found in compose file"
              else
                echo "โ yoda-web service NOT found in docker-compose.yml!"
                echo ""
                echo "Full docker-compose.yml content:"
                cat docker-compose.yml
                exit 1
              fi
            else
              echo "โ docker-compose.yml not found in $(pwd)"
              echo "Available files:"
              ls -la
              exit 1
            fi

            echo ""
            echo "๐ Step 10: Starting frontend service..."
            echo "Command: docker compose up -d yoda-web"
            docker compose up -d yoda-web

            echo ""
            echo "โณ Step 11: Initial wait (5 seconds)..."
            sleep 5
            
            echo ""
            echo "๐ Container status after start:"
            if docker ps | grep yoda-web; then
              echo "โ Container is running"
            else
              echo "โ Container is NOT running"
              echo "All containers:"
              docker ps -a | grep yoda-web
            fi
            
            echo ""
            echo "๐ Container inspection:"
            CONTAINER_STATUS=$(docker inspect yoda-web --format '{{.State.Status}}' 2>/dev/null || echo "not_found")
            CONTAINER_HEALTH=$(docker inspect yoda-web --format '{{.State.Health.Status}}' 2>/dev/null || echo "no_healthcheck")
            echo "Status: $CONTAINER_STATUS"
            echo "Health: $CONTAINER_HEALTH"
            
            echo ""
            echo "๐ Initial container logs (last 30 lines):"
            docker logs yoda-web --tail 30 2>&1 || echo "โ No logs available"

            echo ""
            echo "๐ฅ Step 12: Health check loop (10 attempts, 5s interval)..."
            for i in {1..10}; do
              echo ""
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "๐ Health Check Attempt $i/10 at $(date +%H:%M:%S)"
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              
              # Check if container exists and is running
              if docker ps --format '{{.Names}}' | grep -q "^yoda-web$"; then
                echo "โ Container 'yoda-web' is running"
                
                # Get container details
                UPTIME=$(docker ps --filter name=yoda-web --format '{{.Status}}')
                echo "Uptime: $UPTIME"
                
                # Check health status
                HEALTH=$(docker inspect yoda-web --format '{{.State.Health.Status}}' 2>/dev/null || echo "no_healthcheck")
                echo "Health status: $HEALTH"
                
                # Try to curl health endpoint
                echo "Testing health endpoint..."
                if curl -f -s http://localhost:3000/api/health; then
                  echo ""
                  echo "โโโ DEPLOYMENT SUCCESSFUL! โโโ"
                  echo ""
                  echo "๐ Final deployment status:"
                  docker ps | grep yoda-web
                  echo ""
                  echo "๐ Application is healthy and responding!"
                  exit 0
                else
                  echo "โณ Health endpoint not responding (attempt $i/10)"
                  echo "Curl response:"
                  curl -v http://localhost:3000/api/health 2>&1 | grep -E "HTTP|Connection|curl:" || echo "No response"
                  
                  echo ""
                  echo "Latest logs (last 10 lines):"
                  docker logs yoda-web --tail 10 2>&1
                fi
              else
                echo "โ Container 'yoda-web' is NOT running!"
                echo ""
                echo "Checking all yoda-web containers:"
                docker ps -a | grep yoda-web || echo "No yoda-web containers found at all"
                
                echo ""
                echo "Container logs (if exists):"
                docker logs yoda-web --tail 20 2>&1 || echo "Container not found"
              fi
              
              if [ $i -lt 10 ]; then
                echo "โณ Waiting 5 seconds before next attempt..."
                sleep 5
              fi
            done

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โโโ DEPLOYMENT FAILED โโโ"
            echo "Application did not start properly after 10 attempts"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            echo ""
            echo "๐ QUICK DIAGNOSTICS:"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            # Container status
            if docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep yoda-web; then
              echo "โ Container found"
              
              # Get container logs if exists
              echo ""
              echo "๐ Container Logs (last 50 lines):"
              docker logs yoda-web --tail 50 2>&1 || echo "No logs"
              
              # Check if it's running
              if docker ps --format '{{.Names}}' | grep -q "^yoda-web$"; then
                echo "โ Container is running"
              else
                echo "โ Container stopped. Exit code:"
                docker inspect yoda-web --format '{{.State.ExitCode}}' 2>/dev/null || echo "unknown"
              fi
            else
              echo "โ No yoda-web container found"
              echo ""
              echo "Checking docker-compose.yml:"
              if [ -f docker-compose.yml ]; then
                cat docker-compose.yml | grep -A 10 "yoda-web:" || echo "No yoda-web service in compose file"
              else
                echo "โ docker-compose.yml not found in $(pwd)"
              fi
            fi
            
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            exit 1
