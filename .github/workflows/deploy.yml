name: Build and Deploy Frontend

run-name: ${{ github.repository }} is building and deploying

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

env:
  IMAGE_NAME: ${{ secrets.ALIYUN_ACR_REGISTRY }}/taklip-container/yoda-web
  IMAGE_TAG_LATEST: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - run: echo "๐ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "๐ง This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "๐ The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint
      
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://www.taklip.com/api/v1
          NEXT_PUBLIC_APP_URL: http://www.taklip.com

      - name: Set up QEMU (for multi-platform builds)
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      - name: Build and push multi-platform Docker image to ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG_LATEST }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Deploy to AliCloud ECS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USER }}
          key: ${{ secrets.ALIYUN_ECS_SSH_KEY }}
          script: |
            echo ""
            echo "๐ Step 1: Logging into ACR..."
            if echo "${{ secrets.ALIYUN_ACR_PASSWORD }}" | docker login ${{ secrets.ALIYUN_ACR_REGISTRY }} -u ${{ secrets.ALIYUN_ACR_USERNAME }} --password-stdin; then
              echo "โ ACR login successful"
            else
              echo "โ ACR login failed"
              exit 1
            fi

            echo ""
            echo "๐ฅ Step 2: Pulling latest image..."
            echo "Image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG_LATEST }}"
            if docker pull ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG_LATEST }}; then
              echo "โ Image pulled successfully"
              echo "Image details:"
              docker images | grep yoda-web | head -5
            else
              echo "โ Failed to pull image from ACR"
              echo "Checking available images:"
              docker images | head -10
              exit 1
            fi

            echo ""
            echo "๐ท๏ธ Step 3: Tagging image for compose..."
            if docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG_LATEST }} yoda-web:latest; then
              echo "โ Image tagged as yoda-web:latest"
              docker images | grep yoda-web
            else
              echo "โ Failed to tag image"
              exit 1
            fi

            echo ""
            echo "๐ Step 4: Navigating to deployment directory..."
            if cd /opt/project-yoda/yoda-web; then
              echo "โ Current directory: $(pwd)"
              echo "๐ Files in directory:"
              ls -la | head -20
            else
              echo "โ Directory /opt/project-yoda/yoda-web does not exist!"
              echo "Available directories:"
              ls -la /opt/project-yoda/ || echo "/opt/project-yoda does not exist"
              exit 1
            fi

            echo ""
            echo "๐ Step 5: Stopping existing containers..."
            docker compose down yoda-web --remove-orphans || true
            echo "๐ Checking for remaining yoda-web containers:"
            docker ps -a | grep yoda-web || echo "โ No yoda-web containers found"

            echo ""
            echo "๐งน Step 6: Cleaning up..."
            docker container prune -f || true
            docker rm -f yoda-web 2>/dev/null || echo "No yoda-web container to remove"

            echo ""
            echo "๐ Step 7: Verifying docker-compose.yml..."
            if [ -f docker-compose.yml ]; then
              echo "โ docker-compose.yml exists"
              echo "File size: $(ls -lh docker-compose.yml | awk '{print $5}')"
              echo ""
              echo "๐ Checking yoda-web service configuration:"
              if docker compose config 2>&1 | grep -A 15 yoda-web; then
                echo "โ yoda-web service found in compose file"
              else
                echo "โ yoda-web service NOT found in docker-compose.yml!"
                echo ""
                echo "Full docker-compose.yml content:"
                cat docker-compose.yml
                exit 1
              fi
            else
              echo "โ docker-compose.yml not found in $(pwd)"
              echo "Available files:"
              ls -la
              exit 1
            fi

            echo ""
            echo "๐ Step 8: Verifying Docker network..."
            if docker network ls | grep taklip-shared-network; then
              echo "โ Network taklip-shared-network exists"
              docker network inspect taklip-shared-network --format '{{.Name}}: {{len .Containers}} containers'
            else
              echo "โ๏ธ  Network taklip-shared-network not found"
              echo "Available networks:"
              docker network ls
              echo "Attempting to create network..."
              docker network create taklip-shared-network || echo "Failed to create network"
            fi

            echo ""
            echo "๐ Step 9: Verifying volume paths..."
            if [ -d "$HOME/yoda/uploads" ]; then
              echo "โ Uploads directory exists: $HOME/yoda/uploads"
              echo "Directory size: $(du -sh $HOME/yoda/uploads 2>/dev/null || echo 'unknown')"
              echo "File count: $(find $HOME/yoda/uploads -type f 2>/dev/null | wc -l || echo '0')"
            else
              echo "โ๏ธ  Uploads directory not found: $HOME/yoda/uploads"
              echo "Creating directory..."
              mkdir -p $HOME/yoda/uploads || echo "Failed to create uploads directory"
            fi

            echo ""
            echo "๐ Step 10: Starting frontend service..."
            echo "Command: docker compose up -d yoda-web"
            if docker compose up -d yoda-web 2>&1; then
              echo "โ Docker compose command executed"
            else
              echo "โ Docker compose command failed"
              echo "Checking compose logs:"
              docker compose logs yoda-web 2>&1 || echo "No logs"
              exit 1
            fi

            echo ""
            echo "โณ Step 11: Initial wait (10 seconds)..."
            sleep 10
            
            echo ""
            echo "๐ Container status after start:"
            if docker ps | grep yoda-web; then
              echo "โ Container is running"
            else
              echo "โ Container is NOT running"
              echo "All containers:"
              docker ps -a | grep yoda-web
            fi
            
            echo ""
            echo "๐ Container inspection:"
            CONTAINER_STATUS=$(docker inspect yoda-web --format '{{.State.Status}}' 2>/dev/null || echo "not_found")
            CONTAINER_HEALTH=$(docker inspect yoda-web --format '{{.State.Health.Status}}' 2>/dev/null || echo "no_healthcheck")
            echo "Status: $CONTAINER_STATUS"
            echo "Health: $CONTAINER_HEALTH"
            
            echo ""
            echo "๐ Initial container logs (last 30 lines):"
            docker logs yoda-web --tail 30 2>&1 || echo "โ No logs available"

            echo ""
            echo "๐ฅ Step 12: Health check loop (10 attempts, 10s interval)..."
            for i in {1..10}; do
              echo ""
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "๐ Health Check Attempt $i/10 at $(date +%H:%M:%S)"
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              
              # Check if container exists and is running
              if docker ps --format '{{.Names}}' | grep -q "^yoda-web$"; then
                echo "โ Container 'yoda-web' is running"
                
                # Get container details
                UPTIME=$(docker ps --filter name=yoda-web --format '{{.Status}}')
                echo "Uptime: $UPTIME"
                
                # Check health status
                HEALTH=$(docker inspect yoda-web --format '{{.State.Health.Status}}' 2>/dev/null || echo "no_healthcheck")
                echo "Health status: $HEALTH"
                
                # Try to curl health endpoint
                echo "Testing health endpoint..."
                if curl -f -s http://localhost:3000/api/health; then
                  echo ""
                  echo "โโโ DEPLOYMENT SUCCESSFUL! โโโ"
                  echo ""
                  echo "๐ Final deployment status:"
                  docker ps | grep yoda-web
                  echo ""
                  echo "๐ Application is healthy and responding!"
                  exit 0
                else
                  echo "โณ Health endpoint not responding (attempt $i/10)"
                  echo "Curl response:"
                  curl -v http://localhost:3000/api/health 2>&1 | grep -E "HTTP|Connection|curl:" || echo "No response"
                  
                  echo ""
                  echo "Latest logs (last 10 lines):"
                  docker logs yoda-web --tail 10 2>&1
                fi
              else
                echo "โ Container 'yoda-web' is NOT running!"
                echo ""
                echo "Checking all yoda-web containers:"
                docker ps -a | grep yoda-web || echo "No yoda-web containers found at all"
                
                echo ""
                echo "Container logs (if exists):"
                docker logs yoda-web --tail 20 2>&1 || echo "Container not found"
              fi
              
              if [ $i -lt 10 ]; then
                echo "โณ Waiting 10 seconds before next attempt..."
                sleep 10
              fi
            done

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โโโ DEPLOYMENT FAILED โโโ"
            echo "Application did not start properly after 10 attempts"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            echo ""
            echo "๐ DIAGNOSTIC INFORMATION:"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            echo ""
            echo "1๏ธโฃ Container Status:"
            docker ps -a | grep yoda-web || echo "โ No yoda-web container found"
            
            echo ""
            echo "2๏ธโฃ Container Inspection (if exists):"
            if docker inspect yoda-web >/dev/null 2>&1; then
              echo "State:"
              docker inspect yoda-web --format '{{json .State}}' | jq '.' 2>/dev/null || docker inspect yoda-web --format '{{json .State}}'
              echo ""
              echo "Network:"
              docker inspect yoda-web --format '{{json .NetworkSettings.Networks}}' | jq '.' 2>/dev/null || echo "Network info unavailable"
            else
              echo "โ Container does not exist"
            fi
            
            echo ""
            echo "3๏ธโฃ Full Container Logs (last 100 lines):"
            docker logs yoda-web --tail 100 2>&1 || echo "โ No logs available"
            
            echo ""
            echo "4๏ธโฃ Docker Compose Configuration:"
            echo "File location: $(pwd)/docker-compose.yml"
            if [ -f docker-compose.yml ]; then
              echo "yoda-web service config:"
              docker compose config 2>&1 | grep -A 25 "yoda-web:" || cat docker-compose.yml | grep -A 25 "yoda-web:"
            else
              echo "โ docker-compose.yml not found"
            fi
            
            echo ""
            echo "5๏ธโฃ Network Status:"
            docker network ls | grep taklip || echo "โ No taklip networks found"
            docker network inspect taklip-shared-network 2>&1 | head -30 || echo "Network not found"
            
            echo ""
            echo "6๏ธโฃ Volume Mounts:"
            docker inspect yoda-web --format '{{json .Mounts}}' 2>&1 | jq '.' 2>/dev/null || echo "No mount info"
            echo "Uploads directory:"
            ls -la $HOME/yoda/uploads 2>&1 | head -10 || echo "Directory not found"
            
            echo ""
            echo "7๏ธโฃ Port Status:"
            netstat -tlnp 2>/dev/null | grep 3000 || ss -tlnp 2>/dev/null | grep 3000 || echo "Port 3000 not in use"
            
            echo ""
            echo "8๏ธโฃ Docker System Info:"
            docker info 2>&1 | grep -E "Server Version|Storage Driver|Logging Driver|Cgroup|CPUs|Total Memory" || echo "Docker info unavailable"
            
            echo ""
            echo "9๏ธโฃ Recent Docker Events:"
            docker events --since 5m --until 0s 2>&1 | grep yoda-web || echo "No recent events"
            
            echo ""
            echo "๐ Environment Variables Check:"
            docker inspect yoda-web --format '{{range .Config.Env}}{{println .}}{{end}}' 2>&1 | grep -E "NODE_ENV|NEXT_PUBLIC" || echo "No env vars found"
            
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ก TROUBLESHOOTING TIPS:"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "1. Check if docker-compose.yml includes yoda-web service"
            echo "2. Verify network 'taklip-shared-network' exists"
            echo "3. Check if uploads directory exists: ~/yoda/uploads"
            echo "4. Verify image was built correctly in previous step"
            echo "5. Check container logs above for specific errors"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            exit 1
